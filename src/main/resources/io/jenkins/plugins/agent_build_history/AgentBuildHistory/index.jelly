<?jelly escape-by-default='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form">
  <l:layout title="${%Extended Build History}">
    <st:include page="sidepanel.jelly" it="${it.getComputer()}"/>
    <l:main-panel>
      <h1>
        ${%title(it.computer.displayName)}
      </h1>
      <div class="tr jenkins-!-margin-bottom-3">
        <em>${%disclaimer}</em>
        <j:if test="${!it.loadingComplete}">
          <a tooltip="${%History loading still ongoing}" helpurl="${rootURL}/plugin/pipeline-agent-build-history/help/hint.html" href="#" class="jenkins-help-button" tabindex="9999">
          <span class="abh-not-loaded">?</span></a>
        </j:if>
      </div>
      <div class="help-area tr" style="max-width: 750px;"><div class="help"><p class="jenkins-spinner">Loading...</p></div></div>

      <t:setIconSize/>
      <st:adjunct includes="io.jenkins.plugins.agent_build_history.buildHistory" />
      <st:adjunct includes="io.jenkins.plugins.agent_build_history.AgentBuildHistory.history" />
      <!-- Pagination Controls -->
      <j:set var="page" value="${request.getParameter('page') != null ? request.getParameter('page') : 1}"/>
      <j:set var="pageSize" value="${request.getParameter('pageSize') != null ? request.getParameter('pageSize') : h.getCookie(request, 'pageSize', '20')}"/>
      <j:set var="totalPages" value="${it.totalPages}"/>
      <j:set var="sortColumn" value="${request.getParameter('sortColumn') != null ? request.getParameter('sortColumn') : h.getCookie(request, 'sortColumn', 'startTime')}"/>
      <j:set var="sortOrder" value="${request.getParameter('sortOrder') != null ? request.getParameter('sortOrder') : h.getCookie(request, 'sortOrder', 'desc')}"/>
      <j:set var="statusFilter" value="${request.getParameter('status')}" defaultValue="all"/>

      <div>
        <!-- Pagination Previous/Next Buttons -->
        <div id="abh-pagination-filter-container" class="jenkins-form-item tr help-sibling" data-sort-column="${sortColumn}" data-sort-order="${sortOrder}" data-page-size="${pageSize}">
          <div class="abh-pagination-container">
            <nav aria-label="Page navigation" class="abh-pagination">
              <!-- Previous button -->
              <j:if test="${page &gt; 1}">
                <a class="jenkins-button" tooltip="${%Previous}" href="./?page=${page - 1}&amp;pageSize=${pageSize}&amp;sortColumn=${sortColumn}&amp;sortOrder=${sortOrder}&amp;status=${statusFilter}" aria-label="Previous">
                  <l:icon src="symbol-arrow-back-outline plugin-ionicons-api"/>
                </a>
              </j:if>

              <!-- Page Input Field -->
              <span class="abh-page-label">Page</span>
              <input type="number" id="pageInput" class="jenkins-input abh-page-input" min="1" max="${totalPages}" value="${page}" />
              <span class="abh-page-label">of ${totalPages}</span>

              <!-- Next button -->
              <j:if test="${page &lt; totalPages}">
                <a class="jenkins-button" tooltip="${%Next}" href="./?page=${page + 1}&amp;pageSize=${pageSize}&amp;sortColumn=${sortColumn}&amp;sortOrder=${sortOrder}&amp;status=${statusFilter}" aria-label="Next">
                  <l:icon src="symbol-arrow-forward-outline plugin-ionicons-api"/>
                </a>
              </j:if>
            </nav>

            <!-- Page Size Input -->
            <div class="abh-page-size-selector">
              <label class="abh-page-label" for="pageSizeInput">Items per page:</label>
              <input type="number" id="pageSizeInput" class="jenkins-input abh-page-input" min="1" value="${pageSize}" />
            </div>
          </div>
          <div class="abh-pagination-container">
            <div class="abh-trend--filter">
              <div>
                <div class="jenkins-form-label">Filter by Status<a tooltip="Help for feature: Filter by Status" helpurl="${rootURL}/plugin/pipeline-agent-build-history/help/statusFilter.html" href="#" class="jenkins-help-button" tabindex="9999" title="Help for feature: Filter by Status"><span>?</span></a></div>
                <div class="setting-main">
                  <div class="jenkins-select abh-status-filter" style="width: 100px;">
                    <select id="abh-status-filter" name="status" class="jenkins-select__input">
                      <option value="all" selected="${statusFilter == 'all' ? '': null}">All</option>
                      <option value="success" selected="${statusFilter == 'success' ? '': null}">Success</option>
                      <option value="unstable" selected="${statusFilter == 'unstable' ? '': null}">Unstable</option>
                      <option value="failure" selected="${statusFilter == 'failure' ? '': null}">Failed</option>
                      <option value="aborted" selected="${statusFilter == 'aborted' ? '': null}">Aborted</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="help-area tr">
          <div class="help"></div>
        </div>
      </div>

      <table class="jenkins-table ${iconSize == '16x16' ? 'jenkins-table--small' : iconSize == '24x24' ? 'jenkins-table--medium' : ''}"
             id="projectStatus" style="width: auto;" data-icon-size-class="${iconSizeClass}"
             data-show-text="${%Show nodes}" data-hide-text="${%Hide nodes}" >
        <thead>
          <tr>
            <th class="jenkins-table__cell--tight abh-status">${%S}</th>
            <th>
              <a class="sortheader"
                 href="./?page=${page}&amp;pageSize=${pageSize}&amp;sortColumn=build&amp;sortOrder=${sortColumn == 'build' ? (sortOrder == 'asc' ? 'desc' : 'asc') : sortOrder}">
                ${%Build}
                <j:if test="${sortColumn == 'build'}">
                  <j:choose>
                    <j:when test="${sortOrder == 'asc'}">
                      <l:icon src="symbol-arrow-up-outline plugin-ionicons-api" class="jenkins-!-margin-left-1"/>
                    </j:when>
                    <j:otherwise>
                      <l:icon src="symbol-arrow-down-outline plugin-ionicons-api" class="jenkins-!-margin-left-1"/>
                    </j:otherwise>
                  </j:choose>
                </j:if>
              </a>
            </th>
            <th>${%Message}</th>
            <th>
              <a class="sortheader"
                 href="${request.requestURI}?page=${page}&amp;pageSize=${pageSize}&amp;sortColumn=startTime&amp;sortOrder=${sortColumn == 'startTime' ? (sortOrder == 'asc' ? 'desc' : 'asc') : sortOrder}">
                ${%Started}
                <j:if test="${sortColumn == 'startTime'}">
                  <j:choose>
                    <j:when test="${sortOrder == 'asc'}">
                      <l:icon src="symbol-arrow-up-outline plugin-ionicons-api" class="jenkins-!-margin-left-1"/>
                    </j:when>
                    <j:otherwise>
                      <l:icon src="symbol-arrow-down-outline plugin-ionicons-api" class="jenkins-!-margin-left-1"/>
                    </j:otherwise>
                  </j:choose>
                </j:if>
              </a>
            </th>
            <th>${%Time Since}</th>
            <th>${%Duration}</th>
            <th>${%Status}</th>
            <th/>
            <th class="jenkins-table__cell--tight"></th>
          </tr>
        </thead>
        <tbody>
          ${it.handler.results == null}
          <j:forEach var="result" items="${it.handler.results}">
            <j:set var="run" value="${result.run}"/>
            <j:set var="job" value="${result.job}"/>
            <j:set var="ic" value="${run.iconColor}"/>
            <j:set var="buildStatusSummary" value="${run.buildStatusSummary}"/>

            <tr>
              <td data="${ic.ordinal()}" class="jenkins-table__cell--tight jenkins-table__icon abh-status">
                <div>
                  <l:icon alt="${ic.description}" src="symbol-status-${ic.iconName}"
                          tooltip="${ic.description}"/>
                </div>
              </td>
              <td class="no-wrap">
                <a href="${rootURL}/${result.job.url}" class='jenkins-table__link model-link inside'><span><l:breakable value="${job.fullDisplayName}"/></span></a>
                <a href="${rootURL}/${run.url}" class='jenkins-table__link jenkins-table__badge model-link inside'><span>${run.displayName}</span></a>
              </td>
              <td>
                ${result.cause}
              </td>
              <td>
                ${result.startTime}
              </td>
              <td>
                ${run.timestampString}
                <j:if test="${result.executions.size() &gt; 0}">
                  <j:forEach var="node" items="${result.executions}">
                    <div class="abh-hidden jenkins-hidden">
                      ${node.startTimeSince}
                    </div>
                  </j:forEach>
                </j:if>
              </td>
              <td>
                ${run.durationString}
                <j:if test="${result.executions.size() &gt; 0}">
                  <j:forEach var="node" items="${result.executions}">
                    <div class="abh-hidden jenkins-hidden">
                      ${node.durationString}
                    </div>
                  </j:forEach>
                </j:if>
              </td>
              <td>
                <div style="${buildStatusSummary.isWorse ? 'color: var(--red)' : null}">${buildStatusSummary.message}</div>
                <j:if test="${result.executions.size() &gt; 0}">
                  <j:forEach var="node" items="${result.executions}">
                    <j:set var="nodeStatus" value="${node.flowNodeStatus}"/>
                    <div class="abh-hidden jenkins-hidden" style="${nodeStatus.isWorse() ? 'color: var(--red)' : null}">
                      ${nodeStatus.message}
                    </div>
                  </j:forEach>
                </j:if>
              </td>
              <td>
                <j:if test="${result.executions.size() &gt; 0}">
                  <div class="abh-list__button">
                    <button class="jenkins-button toggle-flow-nodes" tooltip="${%Show nodes}" data-hidden="true">
                      <l:icon src="symbol-chevron-down" id="chevron-down" alt="${%Show all Agents}"/>
                    </button>
                  </div>
                    <j:forEach var="node" items="${result.executions}">
                    <div class="abh-hidden jenkins-hidden">
                      Node: ${node.nodeId}
                    </div>
                  </j:forEach>
                </j:if>
              </td>
              <td class="jenkins-table__cell--tight">
                <div class="jenkins-table__cell__button-wrapper">
                  <a href="${rootURL}/${run.url}console" class="jenkins-button jenkins-button--tertiary" tooltip="${%View Console Output}">
                    <l:icon src="symbol-terminal" alt="${%Console output}"/>
                  </a>
                </div>
              </td>
            </tr>
          </j:forEach>
        </tbody>
      </table>
      <t:rssBar-with-iconSize/>
    </l:main-panel>
  </l:layout>
</j:jelly>